<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Autobattler — Retro Paper</title>
<style>
html,body{height:100%;margin:0;background:rgb(232,216,184);color:rgb(44,44,44);
  font-family: -apple-system, system-ui, ui-sans-serif, Arial, sans-serif}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
.h2{font-weight:800;letter-spacing:1px;text-transform:uppercase}
.panel{background:rgb(49,67,86);border:3px solid rgb(44,44,44);border-radius:6px;padding:10px 12px;margin:12px 14px;color:#f2f2f2}
.subtle{opacity:.9}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:8px 0}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:8px 0}
.slot{position:relative;background:rgb(58,80,99);border:2px solid rgb(44,44,44);border-radius:4px;min-height:64px;display:grid;place-items:center;overflow:hidden}
.slot.sel{outline:3px solid #eab308; outline-offset:2px;}
.badge{font:11px ui-monospace,Menlo,Consolas,monospace;color:rgb(44,44,44);background:#f4e3b6;border:2px solid rgb(44,44,44);padding:2px 6px;border-radius:4px}
.hpbar{position:absolute;left:6px;right:6px;bottom:6px;height:6px;background:#2a3744;border:2px solid rgb(44,44,44);border-radius:4px;overflow:hidden}
.hpfill{height:100%;background:#35c36b}
.row{display:flex;gap:8px;align-items:center;justify-content:space-between}
.btn{background:#f4e3b6;color:rgb(44,44,44);border:3px solid rgb(44,44,44);border-radius:6px;padding:10px 12px;font-weight:700}
.btn:active{transform:translateY(1px)}
.small{font-size:12px;opacity:.9}
#prep .title{display:flex;align-items:center;justify-content:space-between}
#battle{display:none}
.line{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.cell{position:relative;height:104px;background:rgb(58,80,99);border:2px solid rgb(44,44,44);border-radius:6px;display:grid;place-items:center;overflow:hidden;margin:6px 0}
.name{position:absolute;top:4px;left:6px;font-size:11px;color:#f2f2f2;opacity:0.9}
.sprite{width:64px;height:64px;image-rendering: pixelated;display:block;background-size:auto 64px;background-repeat:no-repeat}
.log{font:12px ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;line-height:1.35;max-height:30vh;overflow:auto;background:#0f0f0f;color:#f2f2f2;border:3px solid rgb(44,44,44);border-radius:6px;padding:10px;margin-top:8px}
.win{color:#34d399} .loss{color:#ef4444} .notice{color:#fbbf24}
.diag{position:fixed;left:10px;right:10px;bottom:10px;background:#0f0f0f;color:#d1fae5;border:3px solid rgb(44,44,44);border-radius:6px;padding:8px 10px;font:12px ui-monospace,Menlo,Consolas,monospace;opacity:.9}
</style>
</head>
<body>

<div id="prep">
  <div class="panel">
    <div class="title">
      <div>
        <div class="h2">Enemy Preview</div>
        <div class="small subtle" id="enemyPrev"></div>
      </div>
      <div class="small subtle">Gold: <span id="gold">0</span> • Level: <span id="lvl">0</span> • Units max: <span id="cap">0</span></div>
    </div>
    <div class="h2" style="margin-top:6px">Board</div>
    <div class="grid4" id="rowF"></div>
    <div class="grid4" id="rowB"></div>
    <div class="h2">Bench</div>
    <div class="grid5" id="bench"></div>
  </div>

  <div class="panel">
    <div class="h2">Shop</div>
    <div class="grid4" id="shop"></div>
    <div class="row">
      <button class="btn" id="reroll">Reroll (2g)</button>
      <button class="btn" id="level">Level Up (4g)</button>
      <button class="btn" id="start">Start Battle</button>
      <button class="btn" id="lock">Lock Shop</button>
      <button class="btn" id="spawn">Spawn Starter</button>
    </div>
  </div>
</div>

<div id="battle">
  <div class="panel">
    <div class="row">
      <div class="h2" style="color:#f2f2f2">Battle • Wave <span id="bwavenum">1</span></div>
      <div class="row">
        <button class="btn" id="bspeed">0.5x</button>
        <button class="btn" id="bquit">Back</button>
        <button class="btn" id="bcontinue" disabled>Continue</button>
      </div>
    </div>
    <div class="small subtle" style="color:#f2f2f2;margin:6px 0">Enemies</div><div class="line" id="eline"></div>
    <div class="small subtle" style="color:#f2f2f2;margin:6px 0">Allies</div><div class="line" id="aline"></div>
    <div class="h2" style="color:#f2f2f2;margin-top:8px">Battle Log</div>
    <div class="log" id="blog"></div>
  </div>
</div>

<div id="diag" class="diag">Init: pending…</div>

<script>
const SPRITES = {"Knight": {"idle": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABX0lEQVR4nO3av03DQBQH4AOxAQVNFkByRc0GSIgFkFKzCQtQR2IBRMUA1FSWmIIZQpHKiMixffbZft/XWYn/5Jd78r2zUwIAAAAAANbqLPcBq6rat32nruvs5+VA/t1cjHHQr8+3o5/d3D6Mccps1jCA5H+6UQpg6ZY8gNZgyvzPsx4NFkYBEJoCILTBPcB/TUvbPO3vPnNvKudM/sMM/uFVVe2326fe++92L0X/gFNWHdqUvn75979+q0AppaEDiGFK5q8HIDQFQGgKgNAm7wEer9+b28+blNKm0Qhd3X2EXZUYm/ybNMEdGUBl5c7fFIjQJr8DvH7fN7ZLr0NHI/8mU6CODKCycudvCkRoCoDQFAChKQBCUwCElmUVyBuRZcm/v/DLd6XfR49O/gAAk+syd7oc7SqO+ylwzrmS/wgivQtkAJU1y/w9ByA0BUBoXaZAbudlyR8AAAAAAKCDX2TagIG2/YqrAAAAAElFTkSuQmCC", "w": 48, "h": 48, "frames": 4, "fps": 6}, "attack": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABKklEQVR4nO3bsU3DQBQG4AOxAQVNFojkipoNkBALIKXOJixAHYkFEBUDUFNZYgpmgMJKhSCW/exc/L6vcZH4Ln/xy3dnpRQAAAAAAGCpzqIGaprm+9B32rYNm28KMtRhzgwXEYPsfby//PnZ9c195FSTkaEOc2U4DxsJTpACkJoCkJoCkNrgnXSfnfohxz6NkKGTOcOoU6DNZjv43t3uaczUYWTIncESiNQUgNRCX4T18bB+7a6Pq1LK6t+139XtW5VvLGWoQ0QGTwBSUwBSm30J9Px5V0rpdu7HPn4bSoY6RGTwBCA1BSA1BSA1BSA1BSA1BSA1BSA1BSA1/wcYSYbxlpABAAA4DX02DpeT/4rfvoLHk2GYxWdwDEpqCkBqCgAAAAAAAACwND9YcnZnHsmjWwAAAABJRU5ErkJggg==", "w": 48, "h": 48, "frames": 4, "fps": 8}, "death": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABZElEQVR4nO3cvU3DQBiAYYPYgIImCyC5omYDJMQCSKnZhAVSW2IBRMUA1FSWmIIZoDYhSnw527n7nqezEv9I0es7X6I0DQAAAAAAUKuz3Ads2/Zn33v6vs9+XkhxMcVBPz9ed752c/swxSmzEXAskwRQOgHHIYAKCfhwAuDkzBnwedajQWGOHgH+G7L2Vfp3H3NSlpJlCrRePyXv23WbHJeQTMCxeQZoBBw5YAFUQMDpAQuAxS0ZsFUgQpt9BHi8fhtuP6+aplkNhrSru/ewc1LmZQo0koDrIoBgBDw0ewAvX/eD7a7bhF6GY5zcARsBRhJwXQQQjICHBEBRcgfsewBCEwChCYDQsjwDLP2DKkh1dAA1rCAIOK7wq0ACjq34D5+yHfIvEPvUcBODRYwp53Kyq9jte4FzEkikZwABsyVSAKUT8AQEwFxOMuAxAVR/NyCeSCOAgNkSKYDSCRgAAAAAkvwCHFqA5YaHqusAAAAASUVORK5CYII=", "w": 48, "h": 48, "frames": 4, "fps": 8}}, "Archer": {"idle": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABXElEQVR4nO3aq1LDQBQG4IVBVjCDAMEjRKHpE4DA83x4BAIPGpWHwDCDwLcCFYZOu80mm+R8n+sll/7dM9mzSUoAAAAAAMBSnZTeYdM0m33fadu2+HH5Jf88Z0Ps9OP9eednN7cPQxyymCUMIPkfbpACmLs5D6AlGDP/06J7g5lRAISmAAitdw/wX9Oyb572d5upN5VTJv9+ev/wpmk2V/fnR2//+fJd9Q84ZNVhn9rnL//jz98qUEqp7wCin5r56wEITQEQmgIgtNF7gKf1qvvGepVSuu40Qpd3r2FXJYYm/y5NcCYDqK7S+ZsCEdroV4DHt5/O69rr0NHIv8sUKJMBVFfp/E2BCE0BEJoCIDQFQGgKgNCKrAJ5IrIu+R+vdwEsYQlwzgNI/gAAZMqZP14Mdha7fVU45lTJfwCRngUygOqaZP7uAxCaAiC0nCmQy3ld8gcAAAAAAMiwBQKOg/a7/9SgAAAAAElFTkSuQmCC", "w": 48, "h": 48, "frames": 4, "fps": 6}, "attack": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABLklEQVR4nO3aoU7EQBQF0IEgV5AgQPAJVWj2C0Dg+T48AoEHjepHYEhW4FnRoAhs0762Q985apPdnekVN+3MtBQAAAAAAGCtjqIGaprm69Bv2rYNm28KMtRhzgwnEYN8e3t9/PW7q+u7yKkmI0Md5spwHDYS/EMKQGoKQGoKQGqDV9J9VuqHLL0bIUMnc4ZRu0AXt6eD//v+tBszdRgZdmHXMcZSGTwCkZoCkFroQVgfD9tN92G7KaVc/vnsd37zXOWJpQx1iMjgDkBqCkBqsz8C3b98llK6lfvS229DyVCHiAzuAKSmAKSmAKSmAKSmAKSmAKSmAKSmAKQ26iCslldpx5ChDmvIAAAA1K/PG3Rnk1/FTx/B48kwzOoz2AYlNQUgNQUAAAAAAAAAWJs9QcxwjsYQa2kAAAAASUVORK5CYII=", "w": 48, "h": 48, "frames": 4, "fps": 8}, "death": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABVklEQVR4nO3aLVLDQBiA4cAgK5hBgOAIUWh6AhB4zodHVOBBo3KIGmYq8FSH0inZbpLufs/j+pNszJvdbNs0AAAAAABArc5yn7Bt259D3+m6Lvu4kOJijJN+frzu/ezu/mmMIbMRcCyjBFA6AcchgAoJ+P8EwMmZMuDzrGeDwhw9A/w1ZR2q9Pcx1qTMJcsS6ObxMvnY9WqT4xKSCTg2zwCNgCMHLIAKCDg9YAEwuzkDtgtEaJPPAC/LRf+N5aJpmtvelHb98BZ2Tcq0LIEGEnBdBBCMgPsmD+D5/bv3er3ahN6GY5jcAZsBBhJwXQQQjID7BEBRcgfsdwBCEwChCYDQsjwDzP2HKkh1dAA17CAIOK7wu0ACji18AKUTMJBsyN3jarSr2O9rhjEJJNISSMDsiBRA6QQ8AgEwlZMMeEgA1d8NiCfSDCBgdkQKoHQCBgAAAIAkW5BThAfGYIVNAAAAAElFTkSuQmCC", "w": 48, "h": 48, "frames": 4, "fps": 8}}, "Healer": {"idle": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABYUlEQVR4nO3avU3DQBgG4AOxAQUSygJIrqjZgIYFkCgYJC07UCCxACUDUFNZYgM6ZkgKKiMix/bZZ/t7ni4//smb++T7zk4JAAAAAABYq5PcO6yqatf2nbqusx+XX/Lv5myMnX5+vB387PrmboxDZrOGAST/441SAEu35AG0BlPmf5p1b7AwCoDQFAChDe4B/mta2uZpf7eZe1M5Z/IfZvAPr6pqd/nw3Hv775fHon/AMasObUqfv/z7n79VoJTS0AHEMCXz1wMQmgIgNAVAaJP3AK9X2+YbT5uU0qbRCF3cvoddlRib/Js0wR0ZQGXlzt8UiNAmvwLcf20br0uvQ0cj/yZToI4MoLJy528KRGgKgNAUAKEpAEJTAISWZRXIE5Flyb+/8Mt3pZ9Hj07+AACT6zJ3Oh/tLA77KXDMuZL/CCI9C2QAlTXL/N0HIDQFQGhdpkAu52XJHwAAAAAAoIM9O9R/hQiJyaQAAAAASUVORK5CYII=", "w": 48, "h": 48, "frames": 4, "fps": 6}, "attack": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABMElEQVR4nO3asU3DQBQG4AOxQQoklAWQXKVmAxoWQKJgkLTZgQKJBSgZgJrKEhvQMQMUFhUisexn5/D7vipSkjv/xS/77lwKAAAAAACwVCdRAzVN83XoN23bhs03BRnqMGeGs4hBfry9Pv/53ebqJnKqychQh7kynIaNBP+QApCaApCaApDa4JV0n5X6IcfejZChkznDqF2gi7uHwf/9eLwfM3UYGXJn8AhEagpAaqEHYX08XW67D7t1KWW999nv/PqlyhNLGeoQkcEdgNQUgNRmfwS6fd+WUrqV+7G334aSoQ4RGdwBSE0BSE0BSE0BSE0BSE0BSE0BSE0BSG3UQVgtr9KOIUMdlpABAACoX5836FaTX8Vvn8HjyTDM4jPYBiU1BSA1BQAAAAAAAABYmm+8HmzuRqDiygAAAABJRU5ErkJggg==", "w": 48, "h": 48, "frames": 4, "fps": 8}, "death": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABZklEQVR4nO3cvU3DQBiAYYPYgAIJZQEkV9RsQMMCSBQZJC07UERiAUoGoKayxAbpmAFqE6LEl7Odu+95uvz4R4pe3/kSpWkAAAAAAIBaneXeYdu2P/ve03Vd9uNCiosxdvr58bbztdu7hzEOmY2AYxklgNIJOA4BVEjAhxMAJ2fKgM+z7g0Kc/QI8N+Qta/Sv9uYkzKXLFOg66eX5G0362WOU0gm4NjcAzQCjhywACog4PSABcDs5gzYKhChTT4CvN6s+k88L5qmWfSGtKv797BzUqZlCjSQgOsigGAE3Dd5AI9fq97jzXoZehmOYXIHbAQYSMB1EUAwAu4TAEXJHbDvAQhNAIQmAELLcg8w9w+qINXRAdSwgiDguMKvAgk4tuI/fMp2yL9A7FPDRQxmMaScy9HOYrfvGY5JIJHuAQTMlkgBlE7AIxAAUznJgIcEUP3VgHgijQACZkukAEonYAAAAABI8gvR/n/9cb0hEQAAAABJRU5ErkJggg==", "w": 48, "h": 48, "frames": 4, "fps": 8}}, "Assassin": {"idle": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABXklEQVR4nO3av03DQBQH4ANRpohEQcMIrqjZgAaJLdiACdiALZAoGYCaymsgpaAPBZURkXPx2Wf7fV9nJf6TX+7J985OCQAAAAAAWKuz0gdsmmbf9522bYufl1/yz3MxxkE/P94OfnZzez/GKYtZwwCS//FGKYClW/IAWoMp8z8vejRYGAVAaAqA0Ab3AP81LX3ztL/7zL2pnDP5DzP4hzdNs3/cbk/e/2W3q/oHHLPq0Kf29cv/9Ou3CpRSGjqAGKZm/noAQlMAhKYACG3yHuDhadPdTpuU0nWnEbq6ew+7KjE2+XdpgjMZQHWVzt8UiNAmvwO8Pn93tmuvQ0cj/y5ToEwGUF2l8zcFIjQFQGgKgNAUAKEpAEIrsgrkjci65H+68Mt3td9Hj07+AACTy5k7XY52FYd9VTjnXMl/BJHeBTKA6ppl/p4DEJoCILScKZDbeV3yBwAAAAAAyPADRW6BtTlyhCYAAAAASUVORK5CYII=", "w": 48, "h": 48, "frames": 4, "fps": 6}, "attack": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABMklEQVR4nO3asU3DQBQG4ANRpohEQcMIrqjZgAaJLdiACdiALZAoGYCaymsguaCHwkqFIJb9bB9+39ekSHLnv/hl351LAQAAAAAAtuokaqCmab6O/aZt27D55iBDHZbMcBYxyMH728uv311d30ZONRsZ6rBUhtOwkeAfUgBSUwBSUwBSG72SHrJSP2bt3QgZepkzTNoFut/vR//3qeumTB1Ghi7sOqZYK4NHIFJTAFILPQgb4u5h13+WXSnl8s9nv4ub1ypPLGWoQ0QGdwBSUwBSW/wR6Pnxs5TSr9zX3n4bS4Y6RGRwByA1BSA1BSA1BSA1BSA1BSA1BSA1BSC1SQdhtbxKO4UMddhCBgAAoH5D3qA7n/0qfvoIHk+GcTafwTYoqSkAqSkAAAAAAAAAwNZ8AzhKcDb9Fmf3AAAAAElFTkSuQmCC", "w": 48, "h": 48, "frames": 4, "fps": 8}, "death": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABY0lEQVR4nO3cvU3DQBiA4QNRpohEQcMIrqjZgAaJLdiACdggWyBRMgA1VdZAckEPtRMix87Zzt33PJ2V+EeKXt/5EiUlAAAAAACgVhe5D9g0zW/fe7bbbfbzwhhXUxz06/P94Gt3949TnDIbAccySQClE3AcAqiQgI8nAM7OnAFfZj0aFObkEeC/Iauv0t19zElZSpYp0PN6PXrfTdvmuITRBBybZ4Ak4MgBC6ACAh4fsABY3JIBWwUitNlHgKeXVXc7rVJKt50h7ebhI+yclHmZAg0k4LoIIBgBd80ewNvrT2d707ahl+EYJnfARoCBBFwXAQQj4C4BUJTcAfsegNAEQGgCILQszwBL/6AKxjo5gBpWEAQcV/hVIAHHVvyHT9mO+ReIPjXcxGARQ8q5nuwqDvte4JwEEukZQMDsiRRA6QQ8AQEwl7MMeEgA1d8NiCfSCCBg9kQKoHQCBgAAAIBR/gCny4K5hs/ufwAAAABJRU5ErkJggg==", "w": 48, "h": 48, "frames": 4, "fps": 8}}, "Mage": {"idle": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABX0lEQVR4nO3avVHDQBAG0IOhAwISl6AhIKYDCMjJ6IAGCGiADsjICQgogJiAURvUYAdE8uCRJZ10kva9TGPrx59vR7cnpQQAAAAAAKzVSe4DVlW1bftOXdfZz8sf+XdzNsZBv7/eD352dX03ximzWcMAkv/xRimApVvyAFqDKfM/zXo0WBgFQGgKgNAG9wD/NS1t87T9febeVM6Z/IcZ/MOrqtreXj713v/j57noH3DMqkOb0tcv//7XbxUopTR0ADFMyfz1AISmAAhNARDa5D3A4/3r3vYmpbRpNEIXN59hVyXGJv8mTXBHBlBZufM3BSK0ye8AL28Pje3S69DRyL/JFKgjA6is3PmbAhGaAiA0BUBoCoDQFAChZVkF8kZkWfLvL/zyXen30aOTPwDA5LrMnc5Hu4rDfgucc67kP4JI7wIZQGXNMn/PAQhNARBalymQ23lZ8gcAAAAAAOhgB1B3gUXAHhfdAAAAAElFTkSuQmCC", "w": 48, "h": 48, "frames": 4, "fps": 6}, "attack": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABLklEQVR4nO3aIVLDQBQG4IXpDRCYHiFTgeYGIPA4bsAFEL0AN8DhEQgOgEYwuQZnANFWMbSZ5CVd8r7PVLTdzS/+SXY3pQAAAAAAAHN1EjVQ0zTfh37Ttm3YfGOQoQ5TZlhEDLLz8f7y53cXlzeRU41GhjpMleE0bCT4hxSA1BSA1BSA1HqvpLus1A859m6EDBuZMwzaBbpePfT+7+vnesjUYWTIncEjEKkpAKmFHoR1cX/7tP1cllKWe5/9zq/eqjyxlKEOERncAUhNAUht8kegx+e7Uspm5X7s7be+ZKhDRAZ3AFJTAFJTAFJTAFJTAFJTAFJTAFJTAFIbdBBWy6u0Q8hQhzlkAAAA6tflDbqz0a/it6/g8WToZ/YZbIOSmgKQmgIAAAAAAAAAzM0PeRtu6rI5lg4AAAAASUVORK5CYII=", "w": 48, "h": 48, "frames": 4, "fps": 8}, "death": {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABHTnUeAAABZElEQVR4nO3cvU3DQBiAYYPYgIImI1gU1GwABT0dG7AARRZgAzp6ihQMQE0RZQ1mgNoJkWPn7Mvd9zydlfhHil7f+RKlaQAAAAAAgFqdpT5g27a/fe/ZbDbJzwtjXExx0O+vj72v3dw+THHKZAQcyyQBlE7AcQigQgI+nAA4OXMGfJ70aFCYo0eA/4asvkq39zEnJZckU6D765fR+67WyxSXMJqAY/MM0Ag4csACqICAxwcsALLLGbBVIEKbfQR4fnzb2l40TbPoDGlXd59h56TMyxRoIAHXRQDBCLhr9gBe358626v1MvQyHMOkDtgIMJCA6yKAYATcJQCKkjpg3wMQmgAITQCEluQZIPcPqmCsowOoYQVBwHGFXwUScGzFf/iU7ZB/gehTw00MshhSzuVkV7HfT4ZzEkikZwABsyNSAKUT8AQEwFxOMuAhAVR/NyCeSCOAgNkRKYDSCRgAAAAARvkDgeqB21z1iNgAAAAASUVORK5CYII=", "w": 48, "h": 48, "frames": 4, "fps": 8}}};
(function(){
  const diag = document.getElementById('diag');
  function dmsg(m){ diag.textContent=m; }

  const state = {
    gold: 10, level: 3, cap: 3, benchCap: 5, levelCost: 4,
    rowF: [null,null,null,null],
    rowB: [null,null,null,null],
    bench: [null,null,null,null,null],
    relics: ['Holy Shield'],
    wave: 1, locked: false, selected: null
  };
  const CLASSES = {
    K:{name:'Knight', cls:'Knight', hp:100, atk:10, spd:1.8},
    A:{name:'Archer', cls:'Archer', hp:60, atk:15, spd:1.4},
    H:{name:'Healer', cls:'Healer', hp:50, atk:5,  spd:2.0, heal:15},
    S:{name:'Assassin', cls:'Assassin', hp:55, atk:18, spd:1.6, backstab:true},
    M:{name:'Mage', cls:'Mage', hp:55, atk:14, spd:1.6, splash:true}
  };
  const ENEMIES = [
    {name:'Goblins', count:3, hp:40, atk:8, spd:1.8},
    {name:'Wolves', count:4, hp:35, atk:6, spd:1.4},
    {name:'Slime', count:2, hp:80, atk:12, spd:2.0, poison:5},
    {name:'Ogre Chief', count:1, hp:200, atk:20, spd:2.2}
  ];
  function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;}}
  const rng = mulberry32(1337);
  function rand(){ return rng(); }
  function choice(arr){ return arr[Math.floor(rand()*arr.length)] }
  function makeUnit(code){ const b=CLASSES[code]; return {code, name:b.name, cls:b.cls, maxhp:b.hp, hp:b.hp, atk:b.atk, spd:b.spd, heal:b.heal||0, backstab:!!b.backstab, splash:!!b.splash, tier:1}; }
  function powerUp(u){ u.tier+=1; u.maxhp=Math.round(u.maxhp*1.5); u.hp=u.maxhp; u.atk=Math.round(u.atk*1.5); }
  function icon(u){ return `<div class="badge">${u.name}</div><div class="small" style="color:#f2f2f2">T${u.tier}</div>`; }

  function boardCount(){ return [...state.rowF, ...state.rowB].filter(Boolean).length; }
  function getAt(area, idx){ return area==='rowF'?state.rowF[idx] : area==='rowB'?state.rowB[idx] : state.bench[idx]; }
  function setAt(area, idx, val){ if(area==='rowF') state.rowF[idx]=val; else if(area==='rowB') state.rowB[idx]=val; else state.bench[idx]=val; }

  function slot(area,i,u){
    const d=document.createElement('div'); d.className='slot'; if(state.selected && state.selected.area===area && state.selected.idx===i) d.classList.add('sel');
    d.innerHTML = u?icon(u):'';
    if(u){
      const bar=document.createElement('div'); bar.className='hpbar'; const fill=document.createElement('div'); fill.className='hpfill'; fill.style.width=Math.max(0,Math.round(100*u.hp/u.maxhp))+'%'; bar.appendChild(fill); d.appendChild(bar);
    }
    d.onclick=()=>{
      if(!state.selected){ const u=getAt(area,i); if(!u){ dmsg('Empty slot'); return; } state.selected={area,i}; renderPrep(); return; }
      if(state.selected.area===area && state.selected.idx===i){ state.selected=null; renderPrep(); return; }
      const from=getAt(state.selected.area,state.selected.idx), to=getAt(area,i); if(!from){ state.selected=null; renderPrep(); return; }
      const intoBoard = (state.selected.area==='bench') && (area!=='bench') && !to;
      if(intoBoard && boardCount()>=state.cap){ dmsg('Board full. Level up.'); state.selected=null; renderPrep(); return; }
      setAt(state.selected.area,state.selected.idx,to); setAt(area,i,from); state.selected=null; renderPrep();
    };
    return d;
  }

  function renderPrep(){
    const f=document.getElementById('rowF'), b=document.getElementById('rowB'), bn=document.getElementById('bench');
    f.innerHTML=''; b.innerHTML=''; bn.innerHTML='';
    for(let i=0;i<4;i++){ f.appendChild(slot('rowF',i,state.rowF[i])); }
    for(let i=0;i<4;i++){ b.appendChild(slot('rowB',i,state.rowB[i])); }
    for(let i=0;i<state.benchCap;i++){ bn.appendChild(slot('bench',i,state.bench[i])); }
    document.getElementById('gold').textContent=state.gold;
    document.getElementById('lvl').textContent=state.level;
    document.getElementById('cap').textContent=state.cap;
    const base = ENEMIES[(state.wave-1)%ENEMIES.length];
    document.getElementById('enemyPrev').textContent = `${base.name} ×${base.count}  HP ${base.hp}  ATK ${base.atk}` + (base.poison?`  Poison ${base.poison}`:'');
  }

  function addOrMerge(u){
    const all=[...state.rowF,...state.rowB,...state.bench].filter(Boolean);
    const same=all.filter(x=>x.name===u.name && x.tier===u.tier);
    if(same.length>=2){
      let c=0
      function rem(list){ for(let i=0;i<list.length;i++){ if(list[i] && list[i].name===u.name && list[i].tier===u.tier && c<2){ list[i]=null; c++; } } }
      rem(state.bench); rem(state.rowB); rem(state.rowF);
      const up=makeUnit(u.code); up.tier=u.tier; up.maxhp=u.maxhp; up.hp=u.maxhp; up.atk=u.atk; powerUp(up);
      const s=state.bench.findIndex(x=>!x); if(s!==-1) state.bench[s]=up;
      dmsg(`Merge! ${u.name} → Tier ${up.tier}`);
    }else{
      const i=state.bench.findIndex(x=>!x); if(i!==-1) state.bench[i]=u;
    }
  }

  function rollShop(){
    if(state.locked) return;
    const box=document.getElementById('shop'); box.innerHTML='';
    const codes=Object.keys(CLASSES);
    [0,1,2,3].forEach(()=>{
      const code=codes[Math.floor(rand()*codes.length)]; const u=makeUnit(code);
      const btn=document.createElement('button'); btn.className='btn'; btn.innerHTML=`${u.name}<div class="small subtle">class: ${u.cls}</div>`;
      btn.onclick=()=>{ if(state.gold<2){ dmsg('Need 3g'); return; } const i=state.bench.findIndex(x=>!x); if(i===-1){ dmsg('Bench full'); return; } state.gold-=3; addOrMerge(u); renderPrep(); };
      box.appendChild(btn);
    });
  }

  // Battle
  const SPEEDS=[0.5,0.75,1.0]; let speedIdx=0;
  const PACE=2.3;
  const blogEl=document.getElementById('blog');
  function blog(t, cls){ const p=document.createElement('div'); if(cls) p.className=cls; p.textContent=t; blogEl.appendChild(p); blogEl.scrollTop=blogEl.scrollHeight; }
  function clearBlog(){ blogEl.textContent=''; }

  function setBGFrame(el, conf, frame){
    const x = -conf.w*frame;
    el.style.backgroundImage = 'url('+conf.src+')';
    el.style.backgroundSize = 'auto 64px';
    el.style.backgroundPosition = x+'px 0px';
  }

  function SpritePlayer(name, action='idle'){
    const conf=SPRITES[name][action];
    const s={name, action, conf, frame:0, t:0};
    return s;
  }
  function stepAnim(sp, dt){
    sp.t += dt;
    const dur=1/sp.conf.fps;
    if(sp.t >= dur){ sp.t -= dur; sp.frame=(sp.frame+1)%sp.conf.frames; }
  }
  function play(sp, action){ if(!SPRITES[sp.name][action]) return; sp.action=action; sp.conf=SPRITES[sp.name][action]; sp.frame=0; sp.t=0; }

  function cell(label,hp,maxhp,cls){
    const c=document.createElement('div'); c.className='cell';
    const spr=document.createElement('div'); spr.className='sprite'; c.appendChild(spr);
    const nm=document.createElement('div'); nm.className='name'; nm.textContent=label; c.appendChild(nm);
    const hb=document.createElement('div'); hb.className='hpbar'; const fill=document.createElement('div'); fill.className='hpfill'; fill.style.width=Math.round(100*hp/maxhp)+'%'; hb.appendChild(fill); c.appendChild(hb);
    const sp=SpritePlayer(cls,'idle'); setBGFrame(spr, sp.conf, 0);
    return {c,spr,fill,sp};
  }

  let battle=null;
  function toBattle(){
    clearBlog();
    const party=[];
    for(let i=0;i<4;i++){ const u=state.rowF[i]; if(u) party.push({u:{...u}, next:u.spd*PACE}); }
    for(let i=0;i<4;i++){ const u=state.rowB[i]; if(u) party.push({u:{...u}, next:u.spd*PACE}); }
    if(!party.length){ dmsg('No units on board'); return; }
    party.forEach(p=>p.u.hp=Math.min(p.u.maxhp+5,p.u.hp+5));
    const base=ENEMIES[(state.wave-1)%ENEMIES.length];
    const mobs=[]; for(let i=0;i<base.count;i++){ const mh=Math.round(base.hp*(1+0.18*(state.wave-1))); mobs.push({name:base.name, hp:mh, maxhp:mh, atk:Math.round(base.atk*(1+0.12*(state.wave-1))), spd:base.spd, next:base.spd*PACE}); }
    battle={party,mobs,poison:base.poison||0, t:0, dt:0.06, speed:SPEEDS[speedIdx], running:true, result:null};
    document.getElementById('bwavenum').textContent=state.wave;
    renderField();
    document.getElementById('prep').style.display='none'; document.getElementById('battle').style.display='block';
    blog(`▶ Wave ${state.wave}: ${base.name} appear.`,'notice');
    loop();
  }

  function renderField(){
    const eline=document.getElementById('eline'), aline=document.getElementById('aline');
    eline.innerHTML=''; aline.innerHTML='';
    for(let i=0;i<4;i++){ const m=battle.mobs[i]; if(m){ const d=cell(battle.mobs[0].name,m.hp,m.maxhp,'Knight'); m._=d; eline.appendChild(d.c);} else { eline.appendChild(Object.assign(document.createElement('div'),{className:'cell'})); } }
    for(let i=0;i<4;i++){ const p=battle.party[i]; if(p){ const d=cell(p.u.name,p.u.hp,p.u.maxhp,p.u.cls); p._=d; aline.appendChild(d.c);} else { aline.appendChild(Object.assign(document.createElement('div'),{className:'cell'})); } }
  }

  function pickAlive(arr){ const alive=arr.filter(x=>x.hp>0); return alive.length?alive[Math.floor(rand()*alive.length)]:null; }
  function endBattle(v){ battle.running=false; battle.result=v?'win':'loss'; document.getElementById('bcontinue').disabled=false; blog(v?'Victory! +5 gold. Tap Continue.':'Defeat... Tap Continue.', v?'win':'loss'); }

  function loop(){
    if(!battle || !battle.running) return;
    const step=battle.dt*battle.speed; battle.t+=step;

    for(const p of battle.party){ if(p._){ stepAnim(p._.sp, step); setBGFrame(p._.spr, p._.sp.conf, p._.sp.frame); } }
    for(const m of battle.mobs){ if(m._){ stepAnim(m._.sp, step); setBGFrame(m._.spr, m._.sp.conf, m._.sp.frame); } }

    if(battle.poison && Math.floor(battle.t)%3===0 && Math.abs(battle.t-Math.floor(battle.t))<1e-9){
      battle.party.forEach(p=>{ if(p.u.hp>0){ p.u.hp-=battle.poison; if(p._) p._.fill.style.width=Math.round(100*p.u.hp/p.u.maxhp)+'%'; blog(`Poison ticks for ${battle.poison}.`); } });
    }

    for(const p of battle.party){
      if(p.u.hp<=0) continue;
      p.next -= step;
      if(p.next<=0){
        if(p.u.heal){
          const tgt=battle.party.reduce((a,c)=> (c.u.hp>0 && (!a||c.u.hp<a.u.hp))?c:a, null);
          if(tgt){ const pre=tgt.u.hp; tgt.u.hp=Math.min(tgt.u.maxhp, tgt.u.hp + p.u.heal); if(tgt._) tgt._.fill.style.width=Math.round(100*tgt.u.hp/tgt.u.maxhp)+'%'; blog(`${p.u.name} heals ${tgt.u.name} for ${tgt.u.hp-pre}.`); }
        }else{
          const t=pickAlive(battle.mobs);
          if(t){ let dmg=p.u.atk; if(p.u.backstab) dmg=Math.round(dmg*1.2);
            t.hp-=dmg; if(t._) t._.fill.style.width=Math.round(100*t.hp/t.maxhp)+'%'; blog(`${p.u.name} hits ${t.name} for ${dmg}.`);
            if(p._){ play(p._.sp,'attack'); setTimeout(()=>{ if(p._) play(p._.sp,'idle'); }, 380); }
          }
        }
        p.next += p.u.spd*PACE;
      }
    }
    for(const m of battle.mobs){
      if(m.hp<=0) continue;
      m.next -= step;
      if(m.next<=0){
        const tgt = pickAlive(battle.party.map(x=>x.u));
        if(tgt){ tgt.hp-=m.atk; const wrap=battle.party.find(pp=>pp.u===tgt); if(wrap && wrap._) wrap._.fill.style.width=Math.round(100*wrap.u.hp/wrap.u.maxhp)+'%'; blog(`${m.name} hits ${tgt.name} for ${m.atk}.`);
          if(m._){ play(m._.sp,'attack'); setTimeout(()=>{ if(m._) play(m._.sp,'idle'); }, 380); }
        }
        m.next += m.spd*PACE;
      }
    }

    battle.mobs=battle.mobs.filter(m=>m.hp>0);
    const partyAlive=battle.party.some(p=>p.u.hp>0), mobsAlive=battle.mobs.length>0;
    if(!partyAlive || !mobsAlive || battle.t>120){ endBattle(!mobsAlive && partyAlive); return; }
    requestAnimationFrame(loop);
  }

  // Buttons
  function wire(){
    document.getElementById('reroll').onclick=()=>{ if(state.gold<2){ dmsg('Not enough gold'); return; } state.gold-=2; state.locked=false; rollShop(); renderPrep(); };
    document.getElementById('lock').onclick=()=>{ state.locked=!state.locked; dmsg(state.locked?'Shop locked':'Shop unlocked'); };
    document.getElementById('level').onclick=()=>{ if(state.gold<state.levelCost){ dmsg(`Need ${state.levelCost}}g`); return; } state.gold-=state.levelCost; state.level+=1; state.cap=Math.min(6,state.cap+1); state.levelCost+=2; renderPrep(); };
    document.getElementById('start').onclick=()=>{ document.getElementById('bcontinue').disabled = true; toBattle(); };
    document.getElementById('spawn').onclick=()=>{ state.rowF=[makeUnit('K'),null,null,null]; state.rowB=[null,makeUnit('A'),null,null]; state.bench=[makeUnit('H'),null,null,null,null]; renderPrep(); };
    document.getElementById('bquit').onclick=()=>{ document.getElementById('battle').style.display='none'; document.getElementById('prep').style.display='block'; };
    document.getElementById('bspeed').onclick=()=>{ speedIdx=(speedIdx+1)%SPEEDS.length; if(battle) battle.speed=SPEEDS[speedIdx]; document.getElementById('bspeed').textContent=SPEEDS[speedIdx]+'x'; };
    document.getElementById('bcontinue').onclick=()=>{
      const victory = (battle && battle.result==='win');
      if(victory){ state.wave += 1; state.gold += 5; for(const u of [...state.rowF,...state.rowB].filter(Boolean)){ u.hp=Math.max(u.hp, Math.floor(u.maxhp*0.7)); } }
      renderPrep(); rollShop();
      document.getElementById('battle').style.display='none'; document.getElementById('prep').style.display='block';
    };
  }

  function init(){
    try{
      wire();
      state.rowF[0]=makeUnit('K'); state.rowB[1]=makeUnit('A'); state.bench[0]=makeUnit('H');
      renderPrep(); rollShop();
      dmsg('Init OK — Retro Paper build');
    }catch(e){ dmsg('Init error: '+e.message); }
  }
  if(document.readyState==='complete' || document.readyState==='interactive'){ setTimeout(init, 0); } else { document.addEventListener('DOMContentLoaded', init); }
})();
</script>
</body>
</html>
