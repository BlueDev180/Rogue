<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Autobattler — GitHub Safe v2 (Battle Log)</title>
<style>
:root{
  --bg:#0b0b0b;--panel:#151515;--text:#eaeaea;--muted:#9aa0a6;--accent:#4dabf7;
  --slot:#1f1f1f;--grid:#2a2a2a;--sel:#3b82f6;--hp:#22c55e;--hpbg:#3a3a3a;
  --enemy:#b45309; --ally:#2563eb; --win:#34d399; --loss:#ef4444; --notice:#fbbf24;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
.panel{background:var(--panel);border:1px solid #222;border-radius:12px;padding:10px 12px;margin:10px 14px}
.btn{background:#1e1e1e;border:1px solid #333;color:#eaeaea;border-radius:10px;padding:12px 14px;text-align:center;user-select:none}
.row{display:flex;gap:8px;align-items:center;justify-content:space-between}
.small{font-size:12px;color:var(--muted)}
.board{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:8px 0}
.slot{position:relative;background:var(--slot);border:1px dashed var(--grid);border-radius:10px;min-height:64px;display:grid;place-items:center;padding:6px;overflow:hidden}
.slot.sel{outline:2px solid var(--sel); outline-offset:2px;}
.unit{display:grid;gap:2px;place-items:center}
.badge{font:11px ui-monospace,Menlo,Consolas,monospace;color:#111;background:var(--accent);padding:1px 6px;border-radius:999px}
.hpbar{position:absolute;left:6px;right:6px;bottom:6px;height:6px;background:var(--hpbg);border-radius:6px;overflow:hidden}
.hpfill{height:100%;background:var(--hp);}
.shop{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0}
.controls{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
#diag{position:fixed;left:10px;right:10px;bottom:10px;background:#111;border:1px solid #333;border-radius:10px;padding:8px 10px;font:12px ui-monospace,Menlo,Consolas,monospace}
.ok{color:#34d399} .warn{color:#f59e0b} .err{color:#ef4444}
#battle{display:none}
.grid2{display:grid;gap:8px}
.line{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.cell{position:relative;height:88px;background:#111;border:1px solid #222;border-radius:10px;display:grid;place-items:center;overflow:hidden;margin:6px 0}
.name{position:absolute;top:4px;left:6px;font-size:11px;color:#ddd;opacity:0.9}
.cell .hpbar{position:absolute;left:6px;right:6px;bottom:6px;height:6px;background:#1e1e1e;border-radius:6px;overflow:hidden}
.cell .hpfill{height:100%;background:var(--hp)}
.sprite{width:64px;height:64px;image-rendering: pixelated;background:#2b2b2b;border-radius:8px;display:grid;place-items:center}
.sprite.ally{outline:2px solid var(--ally)} .sprite.enemy{outline:2px solid var(--enemy)}
.flash{animation: flash .25s ease-out}
@keyframes flash{from{filter:brightness(1.6)}to{filter:brightness(1)}}
.log{font:12px ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;line-height:1.35;max-height:32vh;overflow:auto;background:#0f0f0f;border:1px solid #222;border-radius:10px;padding:10px;margin-top:8px}
.win{color:var(--win)} .loss{color:var(--loss)} .notice{color:var(--notice)}
</style>
</head>
<body>

<div id="prep">
  <div class="panel">
    <div class="row">
      <div>
        <h2 style="margin:0">Autobattler — Prep</h2>
        <div class="small">Tap unit → tap slot to move/swap • Merges on 3 copies • Level up to field more units</div>
      </div>
      <div class="small">Gold: <span id="gold">0</span> • Level: <span id="lvl">0</span> • Units max: <span id="cap">0</span></div>
    </div>
    <div class="board" id="rowF"></div>
    <div class="board" id="rowB"></div>
    <div class="row">
      <div class="small" id="enemyPrev"></div>
      <div class="small">Relics: <span id="relics">Shield @ start</span></div>
    </div>
    <div class="board" id="bench" style="grid-template-columns:repeat(5,1fr)"></div>
  </div>

  <div class="panel">
    <div class="row"><strong>Shop</strong> <span class="small">(tap to buy → bench)</span></div>
    <div class="shop" id="shop"></div>
    <div class="controls">
      <div class="btn" id="spawn">Spawn Starter</div>
      <div class="btn" id="reroll">Reroll (2g)</div>
      <div class="btn" id="level">Level Up (4g)</div>
      <div class="btn" id="start">Start Battle</div>
      <div class="btn" id="lock">Lock Shop</div>
    </div>
  </div>
</div>

<div id="battle">
  <div class="panel grid2">
    <div class="row">
      <div><strong>Battle</strong> • Wave <span id="bwavenum">1</span></div>
      <div class="small">
        <button class="btn" id="bspeed">1x</button>
        <button class="btn" id="bquit">Back</button>
        <button class="btn" id="bcontinue" disabled>Continue</button>
      </div>
    </div>

    <div class="small">Enemies</div><div class="line" id="eline"></div>
    <div class="small">Allies</div><div class="line" id="aline"></div>
    <div>
      <div class="row"><strong>Battle Log</strong></div>
      <div class="log" id="blog"></div>
    </div>
  </div>
</div>

<div id="diag"><span class="ok">Init: pending…</span></div>

<script>
(function(){
  const diag = document.getElementById('diag');
  function dmsg(msg, cls){ diag.innerHTML = '<span class="'+(cls||'ok')+'">'+msg+'</span>'; }

  const state = {
    gold: 10, level: 3, cap: 3, benchCap: 5, levelCost: 4,
    rowF: [null,null,null,null],
    rowB: [null,null,null,null],
    bench: [null,null,null,null,null],
    relics: ['Shield @ start'],
    wave: 1, inBattle: false, locked: false,
    selected: null
  };
  const CLASSES = {
    K:{name:'Knight', cls:'tank', hp:100, atk:10, spd:1.2, range:'melee'},
    A:{name:'Archer', cls:'ranger', hp:60, atk:15, spd:0.9, range:'ranged'},
    H:{name:'Healer', cls:'healer', hp:50, atk:5, spd:1.5, range:'support', heal:15},
    S:{name:'Assassin', cls:'assassin', hp:55, atk:18, spd:0.8, range:'melee', backstab:true},
    M:{name:'Mage', cls:'mage', hp:55, atk:14, spd:1.1, range:'ranged', splash:true}
  };
  const ENEMIES = [
    {name:'Goblins', count:3, hp:40, atk:8, spd:1.2},
    {name:'Wolves', count:4, hp:35, atk:6, spd:0.7},
    {name:'Slime', count:2, hp:80, atk:12, spd:1.3, poison:5},
    {name:'Ogre Chief', count:1, hp:200, atk:20, spd:1.5}
  ];
  function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;}}
  const rng = mulberry32(1337);
  function rand(){ return rng(); }
  function choice(arr){ return arr[Math.floor(rand()*arr.length)] }
  function makeUnit(code){
    const b=CLASSES[code]; return {code, name:b.name, cls:b.cls, maxhp:b.hp, hp:b.hp, atk:b.atk, spd:b.spd, heal:b.heal||0, backstab:!!b.backstab, splash:!!b.splash, tier:1};
  }
  function powerUp(u){ u.tier+=1; u.maxhp=Math.round(u.maxhp*1.5); u.hp=u.maxhp; u.atk=Math.round(u.atk*1.5); }
  function icon(u){ return `<div class="unit"><div class="badge">${u.name}</div><div class="small">T${u.tier}</div></div>`; }
  function boardCount(){ return [...state.rowF, ...state.rowB].filter(Boolean).length; }
  function getAt(area, idx){ return area==='rowF'?state.rowF[idx] : area==='rowB'?state.rowB[idx] : state.bench[idx]; }
  function setAt(area, idx, val){ if(area==='rowF') state.rowF[idx]=val; else if(area==='rowB') state.rowB[idx]=val; else state.bench[idx]=val; }

  function renderPrep(){
    const f=document.getElementById('rowF'), b=document.getElementById('rowB'), bench=document.getElementById('bench');
    f.innerHTML=''; b.innerHTML=''; bench.innerHTML='';
    function slot(area,i,u){
      const d=document.createElement('div'); d.className='slot'; if(state.selected && state.selected.area===area && state.selected.idx===i) d.classList.add('sel');
      d.innerHTML = u?icon(u):'';
      if(u){
        const bar=document.createElement('div'); bar.className='hpbar'; const fill=document.createElement('div'); fill.className='hpfill';
        fill.style.width = Math.max(0,Math.round(100*u.hp/u.maxhp))+'%'; bar.appendChild(fill); d.appendChild(bar);
      }
      d.onclick=()=>onSlotTap(area,i);
      return d;
    }
    for(let i=0;i<4;i++){ f.appendChild(slot('rowF',i,state.rowF[i])); }
    for(let i=0;i<4;i++){ b.appendChild(slot('rowB',i,state.rowB[i])); }
    for(let i=0;i<state.benchCap;i++){ bench.appendChild(slot('bench',i,state.bench[i])); }
    document.getElementById('gold').textContent=state.gold;
    document.getElementById('lvl').textContent=state.level;
    document.getElementById('cap').textContent=state.cap;
    document.getElementById('enemyPrev').textContent = enemyPreviewText();
  }
  function onSlotTap(area, idx){
    const sel = state.selected;
    if(!sel){
      const u = getAt(area, idx); if(!u){ dmsg('Empty slot', 'warn'); return; }
      state.selected = {area, idx}; renderPrep(); return;
    }
    if(sel.area===area && sel.idx===idx){ state.selected=null; renderPrep(); return; }
    const fromU = getAt(sel.area, sel.idx); const toU = getAt(area, idx); if(!fromU){ state.selected=null; renderPrep(); return; }
    const movingIntoBoard = (sel.area==='bench') && (area!=='bench') && !toU;
    if(movingIntoBoard && boardCount() >= state.cap){ dmsg(`Board full (${state.cap}). Level up.`, 'warn'); state.selected=null; renderPrep(); return; }
    setAt(sel.area, sel.idx, toU); setAt(area, idx, fromU); state.selected=null; renderPrep();
  }

  function enemyPreviewText(){ const base = ENEMIES[(state.wave-1)%ENEMIES.length]; return `Next: ${base.name} ×${base.count} • HP ${base.hp} • ATK ${base.atk}` + (base.poison?` • Poison ${base.poison}`:''); }

  function rollShop(){
    if(state.locked) return;
    const shop=document.getElementById('shop'); shop.innerHTML='';
    const codes = Object.keys(CLASSES); const offs=[choice(codes), choice(codes), choice(codes)];
    offs.forEach(code => {
      const u=makeUnit(code);
      const btn=document.createElement('div'); btn.className='btn'; btn.innerHTML=`${u.name}<div class="small">${u.cls}</div>`;
      btn.onclick=()=>{
        if(state.gold<3){ dmsg('Not enough gold', 'warn'); return; }
        const idx=state.bench.findIndex(x=>!x); if(idx===-1){ dmsg('Bench full', 'warn'); return; }
        state.gold-=3; addOrMerge(u); renderPrep();
        blog(`Bought ${u.name} (3g).`);
      };
      shop.appendChild(btn);
    });
  }
  function addOrMerge(u){
    const all=[...state.rowF,...state.rowB,...state.bench].filter(Boolean);
    const same=all.filter(x=>x.name===u.name && x.tier===u.tier);
    if(same.length>=2){
      let consumed=0;
      function removeOne(list){
        for(let i=0;i<list.length;i++){
          if(list[i] && list[i].name===u.name && list[i].tier===u.tier && consumed<2){ list[i]=null; consumed++; }
        }
      }
      removeOne(state.bench); removeOne(state.rowB); removeOne(state.rowF);
      const up=makeUnit(u.code); up.tier=u.tier; up.maxhp=u.maxhp; up.hp=u.maxhp; up.atk=u.atk; powerUp(up);
      const slot=state.bench.findIndex(x=>!x); if(slot!==-1) state.bench[slot]=up;
      dmsg(`Merge! ${u.name} → tier ${up.tier}`, 'ok');
      blog(`Merge! ${u.name} → Tier ${up.tier}`);
    }else{
      const idx=state.bench.findIndex(x=>!x); if(idx!==-1) state.bench[idx]=u;
    }
  }

  // Battle with log
  const PACE=1.35;
  let battle=null;
  const blogEl=document.getElementById('blog');
  function blog(msg, cls){ const p=document.createElement('div'); if(cls) p.className=cls; p.textContent=msg; blogEl.appendChild(p); blogEl.scrollTop=blogEl.scrollHeight; }
  function clearBlog(){ blogEl.textContent=''; }

  function toBattle(){
    clearBlog();
    const act=[];
    for(let i=0;i<4;i++){ const u=state.rowF[i]; if(u) act.push({u, side:'ally'}); }
    for(let i=0;i<4;i++){ const u=state.rowB[i]; if(u) act.push({u, side:'ally'}); }
    if(!act.length){ dmsg('No units on board', 'warn'); return; }
    const party=act.slice(0, state.cap).map(x=>({u:{...x.u}, side:'ally', next:x.u.spd*PACE}));
    party.forEach(p=>p.u.hp=Math.min(p.u.maxhp+5,p.u.hp+5));
    const base = ENEMIES[(state.wave-1)%ENEMIES.length];
    const mobs=[]; for(let i=0;i<base.count;i++){ const mh=Math.round(base.hp*(1+0.18*(state.wave-1))); mobs.push({name:base.name, side:'enemy', hp:mh, maxhp:mh, atk:Math.round(base.atk*(1+0.12*(state.wave-1))), spd:base.spd, next:base.spd*PACE}); }
    battle={party,mobs,poison:base.poison||0, t:0, dt:0.08, speed:1, running:true, result:null};
    document.getElementById('bwavenum').textContent=state.wave;
    renderField(battle);
    document.getElementById('prep').style.display='none'; document.getElementById('battle').style.display='block';
    blog(`▶ Wave ${state.wave}: ${base.name} appear.`,'notice');
    loop(battle);
  }
  function renderField(b){
    const eline=document.getElementById('eline'), aline=document.getElementById('aline');
    eline.innerHTML=''; aline.innerHTML='';
    function cell(label,hp,maxhp,side){
      const c=document.createElement('div'); c.className='cell';
      const spr=document.createElement('div'); spr.className='sprite '+(side==='ally'?'ally':'enemy'); c.appendChild(spr);
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=label; c.appendChild(nm);
      const hb=document.createElement('div'); hb.className='hpbar'; const fill=document.createElement('div'); fill.className='hpfill'; fill.style.width=Math.round(100*hp/maxhp)+'%'; hb.appendChild(fill); c.appendChild(hb);
      return {c, spr, fill};
    }
    for(let i=0;i<4;i++){ const m=b.mobs[i]; if(m){ const d=cell(b.mobs[0].name,m.hp,m.maxhp,'enemy'); m._=d; eline.appendChild(d.c);} else { const e=document.createElement('div'); e.className='cell'; eline.appendChild(e);} }
    for(let i=0;i<4;i++){ const p=b.party[i]; if(p){ const d=cell(p.u.name,p.u.hp,p.u.maxhp,'ally'); p._=d; aline.appendChild(d.c);} else { const e=document.createElement('div'); e.className='cell'; aline.appendChild(e);} }
  }
  function pickAlive(arr){ const alive=arr.filter(x=>x.hp>0); return alive.length?alive[Math.floor(rand()*alive.length)]:null; }

  function endBattle(victory){
    battle.running=false;
    battle.result = victory? 'win':'loss';
    document.getElementById('bcontinue').disabled = false;
    if(victory){
      blog('Victory! +5 gold. Tap Continue to return to prep.','win');
    }else{
      blog('Defeat... Tap Continue to return to prep.','loss');
    }
  }

  function loop(b){
    if(!b.running) return;
    const step = b.dt*b.speed; b.t+=step;

    if(b.poison && Math.floor(b.t)%3===0 && Math.abs(b.t-Math.floor(b.t))<1e-9){
      b.party.forEach(p=>{ if(p.u.hp>0){ p.u.hp-=b.poison; if(p._) p._.fill.style.width=Math.round(100*p.u.hp/p.u.maxhp)+'%'; } });
      blog(`Poison clouds tick for ${b.poison} damage.`);
    }

    for(const p of b.party){
      if(p.u.hp<=0) continue;
      p.next -= step;
      if(p.next<=0){
        if(p.u.heal){
          const tgt=b.party.reduce((a,c)=> (c.u.hp>0 && (!a||c.u.hp<a.u.hp))?c:a, null);
          if(tgt){ const pre=tgt.u.hp; tgt.u.hp=Math.min(tgt.u.maxhp, tgt.u.hp + p.u.heal); if(tgt._) tgt._.fill.style.width=Math.round(100*tgt.u.hp/tgt.u.maxhp)+'%'; const amt=tgt.u.hp-pre; blog(`${p.u.name} heals ${tgt.u.name} for ${amt}.`); }
        }else{
          const t=pickAlive(b.mobs);
          if(t){ let dmg=p.u.atk; if(p.u.backstab) dmg=Math.round(dmg*1.2); if(p.u.splash){ const other=pickAlive(b.mobs.filter(m=>m!==t)); t.hp-=dmg; if(other) other.hp-=Math.floor(dmg*0.5); if(t._) t._.fill.style.width=Math.round(100*t.hp/t.maxhp)+'%'; if(other&&other._) other._.fill.style.width=Math.round(100*other.hp/other.maxhp)+'%'; blog(`${p.u.name} hits ${t.name} for ${dmg}` + (other?` and splashes another for ${Math.floor(dmg*0.5)}`:'' ) + '.'); } else { t.hp-=dmg; if(t._) t._.fill.style.width=Math.round(100*t.hp/t.maxhp)+'%'; blog(`${p.u.name} hits ${t.name} for ${dmg}.`); } if(p._){ p._.spr.classList.add('flash'); setTimeout(()=>p._&&p._.spr.classList.remove('flash'),220); } }
        }
        p.next += p.u.spd*PACE;
      }
    }
    for(const m of b.mobs){
      if(m.hp<=0) continue;
      m.next -= step;
      if(m.next<=0){
        const tgt = pickAlive(b.party.map(x=>x.u));
        if(tgt){ tgt.hp-=m.atk; const wrap=b.party.find(pp=>pp.u===tgt); if(wrap && wrap._) wrap._.fill.style.width=Math.round(100*wrap.u.hp/wrap.u.maxhp)+'%'; blog(`${m.name} hits ${tgt.name} for ${m.atk}.`); }
        m.next += m.spd*PACE;
      }
    }

    b.mobs=b.mobs.filter(m=>m.hp>0);
    const partyAlive=b.party.some(p=>p.u.hp>0), mobsAlive=b.mobs.length>0;
    if(!partyAlive || !mobsAlive || b.t>120){
      endBattle(!mobsAlive && partyAlive);
      return;
    }
    requestAnimationFrame(()=>loop(b));
  }

  // Buttons
  function wire(){
    document.getElementById('reroll').onclick=()=>{ if(state.gold<2){ dmsg('Not enough gold', 'warn'); return; } state.gold-=2; state.locked=false; rollShop(); renderPrep(); dmsg('Shop rerolled', 'ok'); };
    document.getElementById('lock').onclick=()=>{ state.locked=!state.locked; dmsg(state.locked?'Shop locked':'Shop unlocked', 'ok'); };
    document.getElementById('level').onclick=()=>{ if(state.gold<state.levelCost){ dmsg(`Need ${state.levelCost}g`, 'warn'); return; } state.gold-=state.levelCost; state.level+=1; state.cap=Math.min(6,state.cap+1); state.levelCost+=2; renderPrep(); dmsg(`Level ${state.level} (cap ${state.cap})`, 'ok'); };
    document.getElementById('start').onclick=()=>{ document.getElementById('bcontinue').disabled = true; toBattle(); };
    document.getElementById('spawn').onclick=()=>{ state.rowF=[makeUnit('K'),null,null,null]; state.rowB=[null,makeUnit('A'),null,null]; state.bench=[makeUnit('H'),null,null,null,null]; renderPrep(); dmsg('Starter units spawned', 'ok'); };
    document.getElementById('bquit').onclick=()=>{ document.getElementById('battle').style.display='none'; document.getElementById('prep').style.display='block'; dmsg('Exited battle early', 'warn'); };
    document.getElementById('bspeed').onclick=()=>{ /* simple toggle */ };
    document.getElementById('bcontinue').onclick=()=>{
      // Apply victory/defeat results and return
      const victory = (battle && battle.result==='win');
      if(victory){
        state.wave += 1; state.gold += 5;
        for(const u of [...state.rowF,...state.rowB].filter(Boolean)){ u.hp = Math.max(u.hp, Math.floor(u.maxhp*0.7)); }
      }
      renderPrep(); rollShop();
      document.getElementById('battle').style.display='none'; document.getElementById('prep').style.display='block';
      dmsg(victory?`Victory! +5g. Wave ${state.wave}`:'Defeat... Try again', victory?'ok':'warn');
    };
  }

  function safeInit(){
    try{
      wire();
      state.rowF[0]=makeUnit('K'); state.rowB[1]=makeUnit('A'); state.bench[0]=makeUnit('H');
      renderPrep(); rollShop();
      dmsg('Init OK — ready', 'ok');
    }catch(e){
      console.error(e); dmsg('Init error: '+e.message, 'err');
    }
  }

  if(document.readyState==='complete' || document.readyState==='interactive'){ setTimeout(safeInit, 0); }
  else { document.addEventListener('DOMContentLoaded', safeInit); }
  window.addEventListener('error', (e)=>{ dmsg('Runtime error: '+e.message, 'err'); });
})();
</script>
</body>
</html>
