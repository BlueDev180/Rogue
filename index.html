<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Step 1 Prototype - Autobattler</title>
  <style>
    body { background: #f4ecd8; font-family: monospace; }
    canvas { background: #e8dcc0; display: block; margin: 1em auto; image-rendering: pixelated; }
    #log { width: 600px; margin: 1em auto; background: #fff8e1; padding: 8px; border: 1px solid #aaa; height: 120px; overflow-y: scroll; }
    #controls { text-align: center; margin: 1em; }
    button { padding: 6px 12px; margin: 0.5em; }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="640" height="360"></canvas>
  <div id="controls">
    <button onclick="startBattle()">Start Battle</button>
    <button onclick="resetGame()">Reset</button>
  </div>
  <div id="log"></div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const logDiv = document.getElementById("log");

function log(msg) {
  const p = document.createElement("div");
  p.textContent = msg;
  logDiv.appendChild(p);
  logDiv.scrollTop = logDiv.scrollHeight;
}

// Load images
const knightImg = new Image();
const archerImg = new Image();
const goblinImg = new Image();
knightImg.src = "knight.png";
archerImg.src = "archer.png";
goblinImg.src = "goblin.png";

let knight = { x: 100, y: 200, tier: 1, hp: 100, atk: 10, idleRow: 0, attackRow: 1 };
let archer = { x: 200, y: 200, tier: 1, hp: 80, atk: 8, idleRow: 0, attackRow: 1 };
let goblins = [
  { x: 400, y: 200, hp: 50, atk: 5 },
  { x: 500, y: 200, hp: 50, atk: 5 }
];

let inBattle = false;
let tick = 0;

function drawUnit(img, unit, col=0, row=0) {
  // Each frame assumed 32x32 in sheet
  const frameW = 32, frameH = 32, scale = 2;
  ctx.drawImage(img, col*frameW, row*frameH, frameW, frameH,
                     unit.x, unit.y, frameW*scale, frameH*scale);
}

function render() {
  ctx.clearRect(0,0,canvas.width, canvas.height);
  // Background
  ctx.fillStyle = "#d9cfa5";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // Draw knight and archer
  drawUnit(knightImg, knight, knight.tier-1, knight.idleRow);
  drawUnit(archerImg, archer, archer.tier-1, archer.idleRow);
  // Draw goblins
  goblins.forEach(g=> {
    drawUnit(goblinImg, g, 0, 0);
  });
}

function battleStep() {
  if (!inBattle) return;
  tick++;
  if (tick % 60 === 0) {
    // Knight attacks first goblin
    let g = goblins[0];
    g.hp -= knight.atk;
    log("Knight hits Goblin for " + knight.atk);
    if (g.hp <= 0) { log("Goblin defeated!"); goblins.shift(); }
  }
  if (tick % 90 === 0 && goblins.length > 0) {
    let g = goblins[0];
    g.hp -= archer.atk;
    log("Archer shoots Goblin for " + archer.atk);
    if (g.hp <= 0) { log("Goblin defeated!"); goblins.shift(); }
  }
  if (tick % 120 === 0 && goblins.length > 0) {
    knight.hp -= goblins[0].atk;
    log("Goblin hits Knight for " + goblins[0].atk);
    if (knight.hp <= 0) { log("Knight has fallen!"); inBattle = false; }
  }
  if (goblins.length === 0) {
    log("Victory!");
    inBattle = false;
  }
}

function loop() {
  render();
  battleStep();
  requestAnimationFrame(loop);
}
loop();

function startBattle() {
  if (inBattle) return;
  log("Battle started!");
  inBattle = true;
  tick = 0;
  goblins = [
    { x: 400, y: 200, hp: 50, atk: 5 },
    { x: 500, y: 200, hp: 50, atk: 5 }
  ];
  knight.hp = 100;
  archer.hp = 80;
}

function resetGame() {
  logDiv.innerHTML = "";
  knight.hp = 100; archer.hp = 80;
  goblins = [
    { x: 400, y: 200, hp: 50, atk: 5 },
    { x: 500, y: 200, hp: 50, atk: 5 }
  ];
  render();
}
</script>
</body>
</html>